import streamlit as st
import qrcode
from PIL import Image, ImageDraw, ImageFont
import io
import os

# Google API client libraries
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload

# --- Configuration des √©tendues (scopes) pour les APIs Google ---
SCOPES = ['https://www.googleapis.com/auth/documents', 'https://www.googleapis.com/auth/drive.file']

# --- Fonction de g√©n√©ration de QR Code avec logo ---
def generate_qr_code_with_logo(url: str, logo_path: str, logo_size_ratio: float = 0.25) -> Image.Image:
    """
    G√©n√®re un code QR pour une URL donn√©e et ins√®re un logo rond au centre.
    """
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_H,
        box_size=10,
        border=4,
    )
    qr.add_data(url)
    qr.make(fit=True)

    qr_img = qr.make_image(fill_color="black", back_color="white").convert("RGB")
    qr_width, qr_height = qr_img.size

    # V√©rifiez si le fichier logo existe. Pour les d√©ploiements Streamlit,
    # le fichier doit √™tre √† la racine du d√©p√¥t ou dans un sous-dossier sp√©cifi√©.
    # st.runtime.get_instance() est une astuce pour v√©rifier l'environnement de d√©ploiement
    # mais os.path.exists est la v√©rification directe.
    if not os.path.exists(logo_path):
        st.error(f"Erreur : Le fichier logo '{logo_path}' est introuvable. "
                 "Veuillez vous assurer qu'il est dans le m√™me r√©pertoire que app.py "
                 "sur votre d√©p√¥t GitHub.")
        # Retourne le QR code sans logo pour √©viter de bloquer l'application
        # mais signale le probl√®me.
        return qr_img

    logo = Image.open(logo_path).convert("RGBA")
    logo_target_width = int(qr_width * logo_size_ratio)
    logo_target_height = int(qr_height * logo_size_ratio)
    logo.thumbnail((logo_target_width, logo_target_height), Image.LANCZOS)

    mask = Image.new('L', logo.size, 0)
    draw_mask = ImageDraw.Draw(mask)
    draw_mask.ellipse((0, 0, logo.width, logo.height), fill=255)

    rounded_logo = Image.new('RGBA', logo.size, (0, 0, 0, 0))
    rounded_logo.paste(logo, (0, 0), mask)

    pos = ((qr_width - rounded_logo.width) // 2, (qr_height - rounded_logo.height) // 2)
    qr_img.paste(rounded_logo, pos, rounded_logo)

    return qr_img

# --- Fonctions pour l'int√©gration Google Docs/Drive API ---

@st.cache_resource
def get_google_service():
    """
    Authentifie et retourne les services Google Docs et Drive.
    Utilise st.cache_resource pour √©viter de recr√©er les services √† chaque r√©ex√©cution.
    Les identifiants sont r√©cup√©r√©s depuis st.secrets sous la section 'google_service_account'.
    """
    required_keys = [
        "type", "project_id", "private_key_id", "private_key",
        "client_email", "client_id", "auth_uri", "token_uri",
        "auth_provider_x509_cert_url", "client_x509_cert_url",
        "universe_domain"
    ]

    credentials_info = {}
    
    # V√©rification que la section 'google_service_account' existe
    if "google_service_account" not in st.secrets:
        st.error("Erreur de configuration des secrets : La section '[google_service_account]' est manquante. "
                 "Veuillez vous assurer que votre fichier secrets.toml sur Streamlit Cloud "
                 "contient cette section et toutes les cl√©s de votre compte de service Google.")
        st.stop() # Arr√™te l'ex√©cution de l'application si les secrets ne sont pas configur√©s

    # R√©cup√©ration des cl√©s sous la section 'google_service_account'
    for key in required_keys:
        if key not in st.secrets["google_service_account"]:
            st.error(f"Erreur de configuration des secrets : La cl√© '{key}' est manquante "
                     f"dans la section '[google_service_account]'. "
                     "Veuillez v√©rifier votre fichier secrets.toml sur Streamlit Cloud.")
            st.stop() # Arr√™te l'ex√©cution si une cl√© sp√©cifique est manquante
        credentials_info[key] = st.secrets["google_service_account"][key]

    try:
        # La cl√© priv√©e doit √™tre trait√©e pour remplacer les '\n' par de vrais retours √† la ligne
        # si elle a √©t√© stock√©e en ligne √©chapp√©e, mais avec les triples guillemets en TOML,
        # elle devrait d√©j√† √™tre correcte. Cependant, une v√©rification peut √™tre utile.
        # Assurez-vous que la cl√© priv√©e ne contient pas de guillemets suppl√©mentaires ou d'espaces.
        creds = service_account.Credentials.from_service_account_info(
            credentials_info, scopes=SCOPES
        )
    except Exception as e:
        st.error(f"Erreur lors de la cr√©ation des identifiants Google. "
                 f"V√©rifiez le format de votre cl√© priv√©e et l'ensemble des informations de votre compte de service. D√©tail : {e}")
        st.stop() # Arr√™te l'ex√©cution si l'authentification √©choue

    docs_service = build('docs', 'v1', credentials=creds)
    drive_service = build('drive', 'v3', credentials=creds)
    return docs_service, drive_service


def create_and_insert_qr_to_doc(docs_service, drive_service, qr_image_buffer: io.BytesIO, page_url_for_doc: str):
    """
    Cr√©e un Google Doc, uploade l'image, la rend publique,
    puis l'ins√®re directement dans le Doc et la centre via l'API Google Docs.
    """
    doc_title = f"QR Code pour {page_url_for_doc}"
    # ADRESSE E-MAIL √Ä PARTAGER AVEC LE DOCUMENT (√† remplacer ou obtenir via secrets si elle change)
    YOUR_EMAIL_FOR_DOC_ACCESS = "savery.plasman@eduhainaut.be" # Gard√© en dur pour votre cas d'usage sp√©cifique

    try:
        # 1. Uploader l'image du QR code vers Google Drive
        file_metadata = {'name': f'qrcode_{doc_title.replace(" ", "_")}.png', 'mimeType': 'image/png'}
        media = MediaIoBaseUpload(qr_image_buffer, mimetype='image/png', resumable=True)
        uploaded_file = drive_service.files().create(body=file_metadata, media_body=media, fields='id').execute()
        image_id = uploaded_file.get('id')
        st.success(f"Image QR code upload√©e sur Google Drive : {uploaded_file.get('name')} (ID: {image_id})")

        # Rendre l'image publiquement accessible pour l'API Docs.
        # C'est n√©cessaire car l'API Docs la r√©cup√®re via une URL publique.
        permission = {
            'type': 'anyone',
            'role': 'reader'
        }
        drive_service.permissions().create(fileId=image_id, body=permission, fields='id').execute()
        st.info("Image QR code rendue publiquement accessible sur Google Drive.")

        # 2. Cr√©er un nouveau Google Doc
        doc_metadata = {'title': doc_title}
        new_doc = docs_service.documents().create(body=doc_metadata).execute()
        document_id = new_doc.get('documentId')
        st.success(f"Document Google Docs cr√©√© : {new_doc.get('title')} (ID: {document_id})")

        # Partager le document avec l'adresse e-mail sp√©cifi√©e
        if YOUR_EMAIL_FOR_DOC_ACCESS:
            permission_to_share_with_user = {
                'type': 'user',
                'role': 'writer', # Ou 'reader' si vous voulez seulement lire
                'emailAddress': YOUR_EMAIL_FOR_DOC_ACCESS
            }
            try:
                drive_service.permissions().create(
                    fileId=document_id,
                    body=permission_to_share_with_user,
                    sendNotificationEmail=False # Pour ne pas recevoir un email √† chaque cr√©ation
                ).execute()
                st.info(f"Document partag√© avec {YOUR_EMAIL_FOR_DOC_ACCESS}.")
            except Exception as e:
                st.warning(f"Impossible de partager le document avec {YOUR_EMAIL_FOR_DOC_ACCESS}. "
                           f"V√©rifiez que votre compte de service a la permission de partager des fichiers Drive. Erreur: {e}")

        # 3. Ins√©rer l'image et la centrer directement via l'API Docs
        st.info("Insertion de l'image dans le document Google Docs...")

        requests_body = [
            {
                'insertInlineImage': {
                    'uri': f'https://drive.google.com/uc?id={image_id}',
                    'location': {
                        'segmentId': '',
                        'index': 1 # Ins√®re l'image au d√©but du document
                    },
                    'objectSize': {
                        'width': {
                            'magnitude': 300,
                            'unit': 'PT'
                        },
                        'height': {
                            'magnitude': 300,
                            'unit': 'PT'
                        }
                    }
                }
            },
            {
                'updateParagraphStyle': {
                    'range': {
                        'segmentId': '',
                        'startIndex': 1, # Applique le style au paragraphe contenant l'image
                        'endIndex': 2
                    },
                    'paragraphStyle': {
                        'alignment': 'CENTER'
                    },
                    'fields': 'alignment'
                }
            }
        ]

        docs_service.documents().batchUpdate(documentId=document_id, body={'requests': requests_body}).execute()
        st.success("Code QR ins√©r√© et centr√© horizontalement dans le document.")

        doc_link = f"https://docs.google.com/document/d/{document_id}/edit"
        st.markdown(f"**Document Google Docs g√©n√©r√© :** [Ouvrir le document]({doc_link})")
        st.info("Pour un centrage vertical exact, un ajustement manuel dans Google Docs peut √™tre n√©cessaire.")

    except Exception as e:
        st.error(f"Une erreur est survenue lors de la cr√©ation ou de l'insertion dans Google Docs : {e}")

# --- Interface utilisateur Streamlit ---
st.set_page_config(
    page_title="G√©n√©rateur de QR Code LPETH",
    page_icon="üîó",
    layout="centered",
    initial_sidebar_state="auto"
)

st.title("G√©n√©rateur de QR Code avec logo LPETH et cr√©ation Google Docs")
st.markdown("---")

st.write("Bienvenue ! Entrez l'URL de la page pour laquelle vous souhaitez g√©n√©rer un code QR. "
          "Le logo LPETH sera ins√©r√© et un nouveau document Google Docs pourra √™tre cr√©√© avec le QR code.")

page_url = st.text_input("Veuillez ins√©rer l'URL de la page ici :", "")

# Le nom du fichier logo. Assurez-vous que ce fichier est pr√©sent dans votre d√©p√¥t GitHub √† la racine.
LOGO_FILE_NAME = "image_74db4d.png" 

if page_url:
    st.subheader("Pr√©visualisation de l'URL :")
    st.code(page_url)

    st.markdown("### Votre Code QR G√©n√©r√© :")

    qr_image_final = generate_qr_code_with_logo(page_url, LOGO_FILE_NAME)

    if qr_image_final:
        st.image(qr_image_final, caption="Code QR avec logo LPETH. Scannez-moi!", use_container_width=False)

        st.markdown("---")
        st.markdown("### Options d'exportation :")

        col1, col2 = st.columns(2)

        with col1:
            # Pr√©parer l'image pour le t√©l√©chargement
            download_buffer = io.BytesIO()
            qr_image_final.save(download_buffer, format="PNG")
            download_buffer.seek(0) # IMPORTANT : revenir au d√©but du buffer

            st.download_button(
                label="T√©l√©charger le Code QR (PNG)",
                data=download_buffer,
                file_name="code_qr_lpeth.png",
                mime="image/png"
            )
            st.info("Une fois t√©l√©charg√©, vous pourrez l'ins√©rer dans Google Docs et ajuster sa taille manuellement.")

        with col2:
            if st.button("Cr√©er un Google Docs avec le QR Code"):
                with st.spinner("Cr√©ation du Google Docs en cours..."):
                    try:
                        docs_service, drive_service = get_google_service()
                        # Pr√©parer le buffer pour l'upload Google Docs
                        upload_buffer = io.BytesIO()
                        qr_image_final.save(upload_buffer, format="PNG")
                        upload_buffer.seek(0) # Rembobiner le buffer pour l'upload

                        # Passer le buffer √† la fonction create_and_insert_qr_to_doc
                        create_and_insert_qr_to_doc(docs_service, drive_service, upload_buffer, page_url)
                    except Exception as e:
                        st.error(f"√âchec de l'initialisation des services Google ou de la cr√©ation du document : {e}")

else:
    st.warning("Veuillez ins√©rer une URL ci-dessus pour g√©n√©rer le code QR.")

st.markdown("---")
st.markdown("D√©velopp√© avec ‚ù§Ô∏è pour LPETH via Streamlit et Google APIs")
